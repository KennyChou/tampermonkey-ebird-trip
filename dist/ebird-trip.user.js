// ==UserScript==
// @name         ebird-trip
// @namespace    https://kennychou.github.io/
// @version      1.0.2
// @description  使用Vue2.x構建Tampermonkey for ebird trip
// @author       Kenny Chou
// @grant        GM_getValue
// @grant        GM_setValue
// @grant        GM_setClipboard
// @grant        GM_info
// @grant        GM_xmlhttpRequest
// @grant        GM.getValue
// @grant        GM.setValue
// @grant        GM.setClipboard
// @grant        GM_info
// @grant        GM.xmlHttpRequest
// @require      https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js
// @require      https://cdnjs.cloudflare.com/ajax/libs/vue/2.6.14/vue.min.js
// @require      https://cdnjs.cloudflare.com/ajax/libs/axios/0.26.1/axios.min.js
// @match        https://ebird.org/mytripreports
// ==/UserScript==

!function(e){var t={};function n(o){if(t[o])return t[o].exports;var i=t[o]={i:o,l:!1,exports:{}};return e[o].call(i.exports,i,i.exports,n),i.l=!0,i.exports}n.m=e,n.c=t,n.d=function(e,t,o){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:o})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var o=Object.create(null);if(n.r(o),Object.defineProperty(o,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var i in e)n.d(o,i,function(t){return e[t]}.bind(null,i));return o},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=6)}([function(e,t){e.exports=XLSX},function(e,t){e.exports=Vue},function(e,t){e.exports=axios},function(e,t,n){"use strict";(function(e){function o(e){return(o="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function i(e,t){if(!e.vueAxiosInstalled){var n=a(t)?function(e){return{axios:e,$http:e}}(t):t;if(function(e){return"object"===o(e)&&Object.keys(e).every((function(t){return a(e[t])}))}(n)){var i=function(e){return e&&e.version&&Number(e.version.split(".")[0])}(e);if(i){var c=i<3?r:s;Object.keys(n).forEach((function(t){c(e,t,n[t])})),e.vueAxiosInstalled=!0}else console.error("[vue-axios] unknown Vue version")}else console.error("[vue-axios] configuration is invalid, expected options are either <axios_instance> or { <registration_key>: <axios_instance> }")}}function r(e,t,n){Object.defineProperty(e.prototype,t,{get:function(){return n}}),e[t]=n}function s(e,t,n){e.config.globalProperties[t]=n,e[t]=n}function a(e){return e&&"function"==typeof e.get&&"function"==typeof e.post}n.d(t,"a",(function(){return i})),"object"==("undefined"==typeof exports?"undefined":o(exports))?e.exports=i:"function"==typeof define&&n(5)?define([],(function(){return i})):window.Vue&&window.axios&&window.Vue.use&&Vue.use(i,window.axios)}).call(this,n(4)(e))},function(e,t){e.exports=function(e){if(!e.webpackPolyfill){var t=Object.create(e);t.children||(t.children=[]),Object.defineProperty(t,"loaded",{enumerable:!0,get:function(){return t.l}}),Object.defineProperty(t,"id",{enumerable:!0,get:function(){return t.i}}),Object.defineProperty(t,"exports",{enumerable:!0}),t.webpackPolyfill=1}return t}},function(e,t){(function(t){e.exports=t}).call(this,{})},function(e,t,n){"use strict";n.r(t);var o=n(1),i=n.n(o),r=n(2),s=n.n(r),a=n(3),c=function(){var e=this,t=e.$createElement,n=e._self._c||t;return n("div",{staticClass:"Page-section-inner Page-section-inner--md"},[""==e.ebirdKey?n("div",[n("label",[n("span",[e._v("輸入eBird Apikey")]),e._v(" "),n("input",{directives:[{name:"model",rawName:"v-model",value:e.inputkey,expression:"inputkey"}],attrs:{type:"text"},domProps:{value:e.inputkey},on:{input:function(t){t.target.composing||(e.inputkey=t.target.value)}}})]),e._v(" "),n("button",{staticClass:"Button Button--highlight",on:{click:e.saveKey}},[e._v("儲存")])]):e._e(),e._v(" "),0==Object.keys(e.sp_info).length?n("div",[n("label",[n("span",[e._v("鳥名顯示方式")]),e._v(" "),n("select",{directives:[{name:"model",rawName:"v-model",value:e.lang,expression:"lang"}],on:{change:function(t){var n=Array.prototype.filter.call(t.target.options,(function(e){return e.selected})).map((function(e){return"_value"in e?e._value:e.value}));e.lang=t.target.multiple?n:n[0]}}},[n("option",{attrs:{value:"zh_TW"}},[e._v("中文俗名")]),e._v(" "),n("option",{attrs:{value:"en"}},[e._v("英文俗名")])]),e._v(" "),n("button",{staticClass:"Button Button--highlight",on:{click:e.loadSp}},[e._v("\n        下載鳥名錄\n      ")])])]):e._e(),e._v(" "),e.info?n("div",[n("p",{domProps:{innerHTML:e._s(e.message)}})]):e._e()])};c._withStripped=!0;var u=n(0);const l={NY:"NY Nest with Young",NE:"NE NNest with Eggs",FS:"CS Carrying Fecal Sac",FR:"FY Feeding Young",CF:"CF Carrying Food",FL:"FL Recently Fledged Young",ON:"ON Occupied Nest",UN:"UN Used Nest",DD:"DD Distraction Display",NB:"NB Nest Building",CM:"CN Carrying Nesting Material",BP:"PE Physiological Evidence",DN:"B Wren/Woodpecker Nest Building",AB:"A Agitated Behavior",VS:"N Visiting Probable Nest Site",CC:"C Courtship, Display or Copulation",T7:"T Territorial Defense",PO:"P Pair in Suitable Habitat",SM:"M Multiple (7+) Singing Birds",S7:"S7 Singing Bird Present 7+ Days",S1:"S Singing Bird",OS:"H In Appropriate Habitat",FO:"F Flyover"};var d=function(e,t,n,o,i,r,s,a){var c,u="function"==typeof e?e.options:e;if(t&&(u.render=t,u.staticRenderFns=n,u._compiled=!0),o&&(u.functional=!0),r&&(u._scopeId="data-v-"+r),s?(c=function(e){(e=e||this.$vnode&&this.$vnode.ssrContext||this.parent&&this.parent.$vnode&&this.parent.$vnode.ssrContext)||"undefined"==typeof __VUE_SSR_CONTEXT__||(e=__VUE_SSR_CONTEXT__),i&&i.call(this,e),e&&e._registeredComponents&&e._registeredComponents.add(s)},u._ssrRegister=c):i&&(c=a?function(){i.call(this,(u.functional?this.parent:this).$root.$options.shadowRoot)}:i),c)if(u.functional){u._injectStyles=c;var l=u.render;u.render=function(e,t){return c.call(t),l(e,t)}}else{var d=u.beforeCreate;u.beforeCreate=d?[].concat(d,c):[c]}return{exports:e,options:u}}({name:"app",data:()=>({AppName:"ebird-trip",AppVersion:"1.0.2",sp_info:{},breeding_code:l,inputkey:"",ebirdKey:"",lang:"zh_TW",pro_code:{P20:"eBird - Casual Observation",P21:"eBird - Stationary Count",P22:"eBird - Traveling Count",P23:"eBird - Exhaustive Area Count"},info:!1,message:""}),mounted(){this.genDownloadButton()},created(){this.ebirdKey=localStorage.getItem("ebirdKey")||"",this.sp_info=JSON.parse(localStorage.getItem("sp_info")||"{}")},methods:{genDownloadButton(){const e=document.getElementsByClassName("kenny-button");for(;e.length>0;)e[0].remove();if(0!=Object.keys(this.sp_info).length&&""!=this.ebirdKey){try{const e=document.getElementById("my-reports-items").getElementsByTagName("li");for(const t of e){const e=t.getElementsByClassName("Heading Heading--h4")[0].id,n=document.createElement("button");n.textContent="下載",n.className="Button Button--highlight kenny-button",n.addEventListener("click",t=>this.download(e)),t.append(n)}}catch(e){this.info=!0,this.message=e}this.info=!1}},array2object:e=>e.reduce((e,t)=>{const n=Object.keys(t)[0];return e[n]=t[n],e}),async loadSp(){this.info=!0,this.message="正在下載鳥名錄中...";const e=await this.$http.get("https://api.ebird.org/v2/ref/taxonomy/ebird?fmt=json&locale="+this.lang);this.sp_info=this.array2object(e.data.map(e=>{var t={};return t[e.speciesCode]={c:e.comName,s:e.sciName,o:e.taxonOrder},t})),localStorage.setItem("sp_info",JSON.stringify(this.sp_info)),this.message="儲存成功",this.genDownloadButton()},saveKey(){localStorage.setItem("ebirdKey",this.inputkey),this.ebirdKey=this.inputkey,this.genDownloadButton(),this.info=!1},async download(e){this.info=!0,this.message=`開啟下載Trip id=${e}<br />`;const t=(await this.$http.get("https://ebird.org/tripreport-internal/v1/checklists/"+e)).data;var n=[];for(const e of t)try{this.message=this.message+`下載Checklist [${e.subId}]...<br />`;const t=(await this.$http.get("https://api.ebird.org/v2/product/checklist/view/"+e.subId,{headers:{"X-eBirdApiToken":this.ebirdKey}})).data;for(const o of t.obs){const i=this.sp_info[o.speciesCode];n.push({"Submission ID":t.subId,"Common Name":i.c,"Scientific Name":i.s,"Taxonomic Order":i.t,Count:o.howManyAtmost,"State/Province":t.subnational1Code,County:"","Location ID":t.locId,Location:e.loc.locName,Latitude:e.loc.lat,Longitude:e.loc.lng,Date:t.obsDt.split(" ")[0],Time:t.obsDt.split(" ")[1],Protocol:this.pro_code[t.protocolId],"Duration (Min)":t.durationHrs?parseInt(60*parseFloat(t.durationHrs)):"","All Obs Reported":t.allObsReported?1:0,"Distance Traveled (km)":t.effortDistanceKm?t.effortDistanceKm:"","Area Covered (ha)":t.effortAreaHa?t.effortAreaHa:"","Number of Observers":t.numObservers,"Breeding Code":o.obsAus?this.breeding_codes[o.obsAux[0].auxCode]:"","Observation Details":o.comments?o.comments:"","Checklist Comments":t.comments?t.comments:""})}}catch(e){return this.message=`ebirdKey 有問題 [${e}]<br />`,this.ebirdKey="",localStorage.removeItem("ebirdKey"),void this.genDownloadButton()}this.message=this.message+"產生Excel...<br/>";const o=u.utils.json_to_sheet(n),i=u.utils.book_new();u.utils.book_append_sheet(i,o,"sheet1");const r=`trip_${e}.xlsx`;this.message=this.message+"開始下載<br/>",u.writeFile(i,r),this.info=!1}}},c,[],!1,null,null,null);d.options.__file="src/app.vue";var p=d.exports;const f="app_vue_"+Date.now(),g=document.createElement("div");g.id=f;document.getElementById("my-reports-heading").after(g);i.a.use(a.a,s.a),new i.a({el:"#"+f,render:e=>e(p)})}]);